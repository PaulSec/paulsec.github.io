
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Experiments with UPnP - PaulSec's blog</title>
  <meta name="author" content="Paul A. (PaulSec)">

  
  <meta name="description" content="This post deals with recent observations regarding UPnP (Universal Plug and Play) protocol &amp; Routers.
In few words, thanks to this protocol, &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://paulsec.github.io/blog/2014/07/03/experiments-with-upnp">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="PaulSec's blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href='http://fonts.googleapis.com/css?family=Quattrocento+Sans|Roboto:400,300' rel='stylesheet' type='text/css'>

  

</head>


<body>
	<div class="container">
		<aside class="left">
			<div class="inner-left">
				<header>
					
  <img src="http://www.gravatar.com/avatar/0b0f4cb32c81edd3e8dca37bde08910c?s=200" alt="Gravatar of Paul A. (PaulSec) " title="Gravatar of Paul A. (PaulSec)" class="profilepic" />

<hgroup>
  <h1><a href="/">PaulSec's blog</a></h1>
  
    <h2 class="subtitle">Security, Tips & Lulz.</h2>
   
</hgroup>


				</header>
				<footer>
					<p>
	
	
</p>
				</footer>
			</div>
		</aside>
    	<section class="right">
    		<div class="inner-right">
    			<div id="posts">
    			  	<article class="post">
    
  <header>
    
      <h1 class="entry-title">Experiments With UPnP</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-03T21:06:06+01:00" pubdate data-updated="true">Jul 3<span>rd</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>This post deals with recent observations regarding UPnP (<em>Universal Plug and Play</em>) protocol &amp; Routers.
In few words, thanks to this protocol, devices (such as file sharing services, games, ..) can be easily connected/deployed.</p>

<p>First, I started to do research on my box to find relevant UPnP functionalities by hand, found some but I had trouble to exploit them.
Few days ago, David Middlehurst released a tool called <a href="https://github.com/nccgroup/UPnP-Pentest-Toolkit">&ldquo;UPnP Pentest Toolkit&rdquo;</a>.</p>

<p>Quick description of the tool that you can find on Github:</p>

<p><em>This tool aims to bring together a range of UPnP assessment features, enabling quick assessment with minimal configuration and set-up. It has been developed to aid security consultants in exploring, spoofing and manipulating of UPnP devices and the underlying protocols at work. It is intended as a proof of concept to be used for research purposes in a trusted environment.</em></p>

<p>I decided to try it, and I was able to browse all my devices having UPnpP functionalities.
I&rsquo;ll not go through all the features of the tool but feel free to check it out. I&rsquo;ll mostly speak about my experiment using my router.</p>

<p>The version of my router didn&rsquo;t &ldquo;allow&rdquo; me to NAT ports so I couldn&rsquo;t access my internal SSH Server, Web servers, VPN etc.
Clearly, marketing bullshit.
However, thanks to this tool, I managed to enumerate the different functions that I was allowed to perform. Here is the list:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Actions:
</span><span class='line'>    GetSpecificPortMappingEntry
</span><span class='line'>        &lt;-NewLeaseDuration
</span><span class='line'>            Data Type: ui4
</span><span class='line'>        &lt;-NewPortMappingDescription
</span><span class='line'>            Data Type: string
</span><span class='line'>        &lt;-NewEnabled
</span><span class='line'>            Data Type: boolean
</span><span class='line'>        &lt;-NewInternalClient
</span><span class='line'>            Data Type: string
</span><span class='line'>        &lt;-NewInternalPort
</span><span class='line'>            Data Type: ui2
</span><span class='line'>        -&gt;NewProtocol
</span><span class='line'>            Allowed Value 2: UDP
</span><span class='line'>            Allowed Value 1: TCP
</span><span class='line'>            Data Type: string
</span><span class='line'>        -&gt;NewExternalPort
</span><span class='line'>            Data Type: ui2
</span><span class='line'>        -&gt;NewRemoteHost
</span><span class='line'>            Data Type: string
</span><span class='line'>    GetGenericPortMappingEntry
</span><span class='line'>        &lt;-NewLeaseDuration
</span><span class='line'>            Data Type: ui4
</span><span class='line'>        &lt;-NewPortMappingDescription
</span><span class='line'>            Data Type: string
</span><span class='line'>        &lt;-NewEnabled
</span><span class='line'>            Data Type: boolean
</span><span class='line'>        &lt;-NewInternalClient
</span><span class='line'>            Data Type: string
</span><span class='line'>        &lt;-NewInternalPort
</span><span class='line'>            Data Type: ui2
</span><span class='line'>        &lt;-NewProtocol
</span><span class='line'>            Allowed Value 2: UDP
</span><span class='line'>            Allowed Value 1: TCP
</span><span class='line'>            Data Type: string
</span><span class='line'>        &lt;-NewExternalPort
</span><span class='line'>            Data Type: ui2
</span><span class='line'>        &lt;-NewRemoteHost
</span><span class='line'>            Data Type: string
</span><span class='line'>        -&gt;NewPortMappingIndex
</span><span class='line'>            Data Type: ui2
</span><span class='line'>    ForceTermination
</span><span class='line'>    RequestConnection
</span><span class='line'>    GetConnectionTypeInfo
</span><span class='line'>        &lt;-NewPossibleConnectionTypes
</span><span class='line'>            Allowed Value 3: IP_Bridged
</span><span class='line'>            Allowed Value 2: IP_Routed
</span><span class='line'>            Allowed Value 1: Unconfigured
</span><span class='line'>            Data Type: string
</span><span class='line'>        &lt;-NewConnectionType
</span><span class='line'>            Data Type: string
</span><span class='line'>    SetConnectionType
</span><span class='line'>        -&gt;NewConnectionType
</span><span class='line'>            Data Type: string
</span><span class='line'>    DeletePortMapping
</span><span class='line'>        -&gt;NewProtocol
</span><span class='line'>            Allowed Value 2: UDP
</span><span class='line'>            Allowed Value 1: TCP
</span><span class='line'>            Data Type: string
</span><span class='line'>        -&gt;NewExternalPort
</span><span class='line'>            Data Type: ui2
</span><span class='line'>        -&gt;NewRemoteHost
</span><span class='line'>            Data Type: string
</span><span class='line'>    GetExternalIPAddress
</span><span class='line'>        &lt;-NewExternalIPAddress
</span><span class='line'>            Data Type: string
</span><span class='line'>    AddPortMapping
</span><span class='line'>        -&gt;NewLeaseDuration
</span><span class='line'>            Data Type: ui4
</span><span class='line'>        -&gt;NewPortMappingDescription
</span><span class='line'>            Data Type: string
</span><span class='line'>        -&gt;NewEnabled
</span><span class='line'>            Data Type: boolean
</span><span class='line'>        -&gt;NewInternalClient
</span><span class='line'>            Data Type: string
</span><span class='line'>        -&gt;NewInternalPort
</span><span class='line'>            Data Type: ui2
</span><span class='line'>        -&gt;NewProtocol
</span><span class='line'>            Allowed Value 2: UDP
</span><span class='line'>            Allowed Value 1: TCP
</span><span class='line'>            Data Type: string
</span><span class='line'>        -&gt;NewExternalPort
</span><span class='line'>            Data Type: ui2
</span><span class='line'>        -&gt;NewRemoteHost
</span><span class='line'>            Data Type: string
</span><span class='line'>    GetCommonLinkProperties
</span><span class='line'>        &lt;-NewPhysicalLinkStatus
</span><span class='line'>            Allowed Value 4: Unavailable
</span><span class='line'>            Allowed Value 3: Initializing
</span><span class='line'>            Allowed Value 2: Down
</span><span class='line'>            Allowed Value 1: Up
</span><span class='line'>            Data Type: string
</span><span class='line'>        &lt;-NewLayer1DownstreamMaxBitRate
</span><span class='line'>            Data Type: ui4
</span><span class='line'>        &lt;-NewLayer1UpstreamMaxBitRate
</span><span class='line'>            Data Type: ui4
</span><span class='line'>        &lt;-NewWANAccessType
</span><span class='line'>            Allowed Value 4: Ethernet
</span><span class='line'>            Allowed Value 3: Cable
</span><span class='line'>            Allowed Value 2: POTS
</span><span class='line'>            Allowed Value 1: DSL
</span><span class='line'>            Data Type: string
</span><span class='line'>    GetDefaultConnectionService
</span><span class='line'>        &lt;-NewDefaultConnectionService
</span><span class='line'>            Data Type: string
</span><span class='line'>    SetDefaultConnectionService
</span><span class='line'>        -&gt;NewDefaultConnectionService
</span><span class='line'>            Data Type: string
</span><span class='line'>
</span><span class='line'>            (...)</span></code></pre></td></tr></table></div></figure>


<p>One of them was interesting. Saw which one? &ndash; the <strong>AddPortMapping</strong> functionality.
Thanks to this, you can add a &ldquo;Port Mapping&rdquo; or directly create a NAT rule. Without authentication, just one HTTP Request.</p>

<p>Format of UPnP communication is based on SOAP (<em>Simple Object Access Protocol</em>) and its structure is composed of an &ldquo;envelope&rdquo;, a XML-based structure.
Here is the structure for the AddPortMapping request:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;s:Envelope</span> <span class="na">xmlns:s=</span><span class="s">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span> <span class="na">s:encodingStyle=</span><span class="s">&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;s:Body&gt;</span>
</span><span class='line'>        <span class="nt">&lt;u:AddPortMapping</span> <span class="na">xmlns:u=</span><span class="s">&quot;urn:schemas-upnp-org:service:WANPPPConnection:1&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;NewRemoteHost&gt;&lt;/NewRemoteHost&gt;</span>
</span><span class='line'>            <span class="nt">&lt;NewExternalPort&gt;</span>9999<span class="nt">&lt;/NewExternalPort&gt;</span>
</span><span class='line'>            <span class="nt">&lt;NewProtocol&gt;</span>TCP<span class="nt">&lt;/NewProtocol&gt;</span>
</span><span class='line'>            <span class="nt">&lt;NewInternalPort&gt;</span>9999<span class="nt">&lt;/NewInternalPort&gt;</span>
</span><span class='line'>            <span class="nt">&lt;NewInternalClient&gt;</span>192.168.1.91<span class="nt">&lt;/NewInternalClient&gt;</span>
</span><span class='line'>            <span class="nt">&lt;NewEnabled&gt;</span>1<span class="nt">&lt;/NewEnabled&gt;</span>
</span><span class='line'>            <span class="nt">&lt;NewPortMappingDescription&gt;</span>omgwtfbbq<span class="nt">&lt;/NewPortMappingDescription&gt;</span>
</span><span class='line'>            <span class="nt">&lt;NewLeaseDuration&gt;</span>0<span class="nt">&lt;/NewLeaseDuration&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/u:AddPortMapping&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/s:Body&gt;</span>
</span><span class='line'><span class="nt">&lt;/s:Envelope&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can find useful information on <a href="http://www.upnp-hacks.org/igd.html">UPnP hacks</a> &ndash; contains amazing resources on UPnP.</p>

<p>Well, to send directly a SOAP from Linux, here is an &ldquo;easy-way&rdquo; if you want to do it by hand:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -X POST --data @body_soap.txt http://192.168.1.254:46465/ctl/IPConn -H <span class="s1">&#39;SOAPAction: &quot;urn:schemas-upnp-org:service:WANIPConnection:1#AddPortMapping&quot;&#39;</span> -H <span class="s1">&#39;Host: 192.168.1.254:46465&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And in <strong>body_soap.txt</strong> the XML structure with all the settings defined as we saw above.</p>

<p>If the request succeeded, the response should looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;s:Envelope</span> <span class="na">xmlns:s=</span><span class="s">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span> <span class="na">s:encodingStyle=</span><span class="s">&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;</span><span class="nt">&gt;&lt;s:Body&gt;&lt;u:AddPortMappingResponse</span> <span class="na">xmlns:u=</span><span class="s">&quot;urn:schemas-upnp-org:service:WANIPConnection:1&quot;</span><span class="nt">/&gt;&lt;/s:Body&gt;&lt;/s:Envelope&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, in few words:</p>

<ul>
<li>Learning stuffs about UPnP was fun and I&rsquo;m sure there&rsquo;s even more to do with it,</li>
<li>UPT is a fun tool,</li>
<li>I found nice tricks, and I can now NAT ports easily bypassing ISP&rsquo;s stupid rules.</li>
</ul>


<p>I think I&rsquo;ll write another post on WFA-Device which stands for <em>Wi-Fi Alliance Device</em> and their UPnP functionalities.
It seems there&rsquo;s some fun stuffs about it.</p>
</div>


</article>


        <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://paulsec.github.io/blog/2014/07/03/experiments-with-upnp/" data-via="" data-counturl="http://paulsec.github.io/blog/2014/07/03/experiments-with-upnp/" >Tweet</a>
  
  
  
</div>





    			</div>
    			<footer id="footer">
    				<p class="credit">
  Copyright &copy; 2015 - Paul A. (PaulSec). Powered by <a href="http://octopress.org">Octopress</a>
</p>


    			</footer>
    			







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




<link href='http://fonts.googleapis.com/css?family=Quattrocento+Sans|Roboto:400,300' rel='stylesheet' type='text/css'>





    		</div>
    	</section>
  	</div>
</body>
</html>
